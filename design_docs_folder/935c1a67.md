# 詳細設計書

---

## 1. 概要

本プログラムは、Pythonを用いて架空の医療データを生成し、決定木やLightGBM、XGBoostなどの機械学習モデルを用いて重症化リスクの予測モデルを構築・評価・可視化する一連の処理を実装しています。  
主な処理内容は以下の通りです。

- データ生成（特徴量とターゲットの作成）
- データの前処理（カテゴリ変数の作成、オーバーサンプリング）
- モデル構築（決定木、LightGBM、XGBoost）
- ハイパーパラメータチューニング（GridSearchCV）
- モデル評価（精度、混同行列、分類レポート）
- モデルの可視化（決定木の図示、特徴量重要度の表示）
- 結果の保存（CSV、SVG、Excelファイル）

---

## 2. 環境・ライブラリ

| ライブラリ名           | 用途                                   |
|------------------------|----------------------------------------|
| numpy                  | 数値計算、乱数生成                     |
| pandas                 | データフレーム操作                     |
| matplotlib.pyplot      | グラフ描画                             |
| seaborn                | 高度なグラフ描画                       |
| sklearn                | 機械学習モデル構築、評価、前処理       |
| graphviz               | 決定木の可視化                         |
| dtreeviz               | 決定木の高度な可視化                   |
| lightgbm               | LightGBMモデル構築                     |
| xgboost                | XGBoostモデル構築                      |

---

## 3. データ生成

### 3.1 サンプル数

- `n_samples = 10000`  
  1万件のサンプルデータを生成します。

### 3.2 特徴量の生成

| 特徴量名 | 内容・生成方法                                                                                          |
|----------|-------------------------------------------------------------------------------------------------------|
| V1 / Age | 20〜80の整数値を一様分布で生成                                                                         |
| V2 / Vaccinated | V1の値に基づく確率で二項分布に従い0/1を生成。確率は `(V1 - 20) * 0.03` を0〜0.95にクリップした値。 |
| V3 / Gender | 0または1をランダムに均等に生成（例：0=女性, 1=男性）                                                  |
| V4 / Comorbidities | 0または1を確率0.7/0.3で生成（基礎疾患の有無）                                                    |
| V5 / Smoking | 0または1を確率0.8/0.2で生成（喫煙の有無）                                                          |
| V6 / Obesity | 0または1を確率0.7/0.3で生成（肥満の有無）                                                          |
| V7 / Hypoxia | 0または1を確率0.9/0.1で生成（低酸素血症の有無）                                                    |

### 3.3 リスクスコアの計算

- 基本スコアは `(V1 - 20) * 0.005` を0〜0.2にクリップ
- 他の特徴量の影響を乗算で加味  
  `risk_score *= (1 + 2*V4 + 0.5*V5 + 1.5*V6 + 2*V7 + 0.1*V3)`
- V2（ワクチン接種）の効果でリスク軽減  
  `risk_score *= (1 - 0.5 * V2)`
- 最終的に0〜1にクリップ

### 3.4 ターゲット変数の生成

- リスクスコアを成功確率とした二項分布から0/1を生成し、ターゲット（重症化の有無）とする。

### 3.5 データフレーム化

- 生成した特徴量とターゲットを`pandas.DataFrame`にまとめる。

### 3.6 カテゴリ変数の追加

- V1を6つの年齢層に分割し、`V1_Category`列を追加（例：20-30, 30-40,...）

### 3.7 データ保存

- `./decision_tree_input/generated_data_anonymized.csv` にCSV形式で保存

---

## 4. データ可視化

### 4.1 各要因とターゲットの関係

- `V2, V3, V4, V5, V6, V7` の各特徴量と`V1_Category`ごとのターゲット平均値（重症化率）を棒グラフで表示・保存（SVG形式）

### 4.2 V2とターゲットの関係（年齢層無視）

- `V2`ごとのターゲット平均値を棒グラフで表示・保存

---

## 5. データ前処理

### 5.1 カテゴリ変数の削除

- 決定木モデル用に`V1_Category`列を削除

### 5.2 特徴量とターゲットの分離

- `X = data.drop('Target', axis=1)`
- `y = data['Target']`

### 5.3 データ分割

- 訓練データとテストデータに8:2で分割（`random_state=42`で再現性確保）

### 5.4 オーバーサンプリング（少数クラスの増加）

- 訓練データの少数クラス（Target=1）を多数クラス（Target=0）に合わせてリサンプリング（複製）し、クラスバランスを調整

---

## 6. モデル構築・学習（決定木）

### 6.1 パイプライン構築

- `Pipeline`にて決定木分類器（`DecisionTreeClassifier`）を設定

### 6.2 ハイパーパラメータグリッド

| パラメータ名               | 値の候補                      |
|----------------------------|------------------------------|
| criterion                  | 'gini', 'entropy'            |
| splitter                  | 'best', 'random'             |
| max_depth                 | 3, 5, 10                     |
| min_samples_split         | 2, 10, 20                   |
| min_samples_leaf          | 1, 5, 10                    |

### 6.3 グリッドサーチ

- 5分割交差検証（`cv=5`）で精度（accuracy）を評価指標に最適パラメータを探索
- 並列処理（`n_jobs=-1`）で高速化

### 6.4 モデル学習

- オーバーサンプリング済みの訓練データで学習

---

## 7. モデル評価（決定木）

### 7.1 テストデータ予測

- 最良モデルでテストデータのターゲットを予測

### 7.2 評価指標算出

- 混同行列（confusion_matrix）
- 精度（accuracy_score）
- 分類レポート（classification_report）

### 7.3 混同行列の可視化

- ヒートマップ形式で表示し、SVGファイルに保存

### 7.4 特徴量重要度の表示

- 決定木の特徴量重要度を棒グラフで表示・保存

---

## 8. モデルの深さによる性能評価

### 8.1 max_depthを1〜14まで変化させて学習・評価

- 各max_depthで決定木を学習
- 訓練データとテストデータの精度を記録
- 混同行列を計算しSVGで保存
- 決定木の構造をGraphvizでSVG保存

### 8.2 精度推移の可視化

- max_depthに対する訓練精度とテスト精度を折れ線グラフで表示・保存

### 8.3 評価指標のExcel保存

- max_depthごとの精度、適合率、再現率、F1スコアをExcelファイルに保存

---

## 9. 決定木の可視化

### 9.1 export_graphvizによる可視化

- DOT形式で決定木構造を出力し、GraphvizでSVGファイルに保存

### 9.2 dtreevizによる高度な可視化

- 決定木の分岐条件や特徴量の影響を視覚的に表示
- SVGファイルに保存し、Jupyter Notebookなどで表示可能

---

## 10. オーバーサンプリングなしの決定木モデル

- オーバーサンプリングを行わずに同様の処理を実施
- 特徴量の標準化（`StandardScaler`）をパイプラインに追加
- ハイパーパラメータチューニング、評価、可視化を実施

---

## 11. LightGBMモデルの構築・評価

### 11.1 データ読み込み・前処理

- 既存のCSVデータを読み込み
- 不要な列（例：`AgeGroup`）を削除
- 特徴量とターゲットに分離
- 訓練・テスト分割
- 訓練データの少数クラスをオーバーサンプリングでバランス調整

### 11.2 パイプライン構築

- 標準化（`StandardScaler`）＋LightGBM分類器（`LGBMClassifier`）

### 11.3 ハイパーパラメータグリッド

| パラメータ名       | 候補値                      |
|--------------------|----------------------------|
| num_leaves         | 31, 50, 100                |
| learning_rate      | 0.1, 0.01, 0.001           |
| n_estimators       | 100, 200, 500              |

### 11.4 グリッドサーチ、学習、評価

- 5分割交差検証で最適パラメータ探索
- テストデータで予測・評価（精度、分類レポート）

---

## 12. XGBoostモデルの構築・評価

### 12.1 データ生成

- 年齢、ワクチン接種、性別、基礎疾患、喫煙、肥満、低酸素血症の特徴量を生成
- 年齢に基づく重症化率を計算し、各特徴量の影響を乗算
- ワクチン接種の効果を考慮し、最終的な重症化率を算出
- 二項分布で重症化の有無を決定

### 12.2 データ可視化

- 年齢別の重症化分布ヒストグラム
- ワクチン接種の有無と重症化率の関係（年齢層無視・年齢層別）
- クロス集計表の作成

### 12.3 モデル構築

- 特徴量とターゲットに分離し、訓練・テスト分割
- XGBoost分類器（`XGBClassifier`）を用い、ハイパーパラメータチューニング（GridSearchCV）

| パラメータ名       | 候補値                      |
|--------------------|----------------------------|
| max_depth          | 3, 5, 7, 10                |
| learning_rate      | 0.01, 0.1, 0.2             |
| n_estimators       | 100, 200, 500              |
| subsample          | 0.8, 1.0                   |

### 12.4 評価

- テストデータで予測・評価（精度、混同行列、分類レポート）
- 混同行列のヒートマップ表示
- 予測結果と実際の重症化率を散布図で比較（年齢・ワクチン接種状況別）

---

## 13. その他

- 各種グラフはSVG形式で保存し、再利用や高品質な表示に対応
- 再現性確保のため乱数シードは固定（`np.random.seed(42)`）
- ディレクトリが存在しない場合は自動作成（`os.makedirs`）
- コメントを多用し、処理内容を明確に記述

---

## 14. 処理の流れまとめ

1. データ生成 → 2. データ保存 → 3. データ可視化 → 4. データ前処理（オーバーサンプリング含む）  
5. モデル構築（決定木、LightGBM、XGBoost） → 6. ハイパーパラメータチューニング → 7. モデル評価  
8. モデル可視化 → 9. 結果保存・表示

---

以上が本Pythonコードの詳細設計書となります。  
ご不明点や追加説明が必要な箇所がございましたら、お気軽にお知らせください。