# 詳細設計書

---

## 1. 概要

本プログラムは、以下の3つの主要機能を実装しています。

1. 株価データの取得（Yahoo Financeからの1年間の日次データの取得）
2. 日本経済新聞のニュースタイトルとURLのスクレイピング
3. 機械学習モデル（回帰木・分類木）を用いたデータ生成、学習、予測および可視化

---

## 2. 環境・前提条件

- Python 3.x
- ライブラリ
  - pandas
  - numpy
  - matplotlib
  - seaborn
  - yfinance
  - requests
  - beautifulsoup4
  - scikit-learn

---

## 3. 各機能詳細

### 3.1 株価データの取得

#### 目的

Yahoo Financeから指定した銘柄の過去1年間の日次株価データを取得し、データフレームとして保持します。

#### 入力

- `ticker` : 文字列  
  例） `"4755.T"`（日本の証券コード形式）

#### 処理内容

1. `yfinance`ライブラリの`download`関数を用いて、指定銘柄の1年間（`period='1y'`）、日次（`interval='1d'`）の株価データを取得します。
2. 取得したデータは`pandas.DataFrame`形式で格納されます。

#### 出力

- `data` : pandas.DataFrame  
  株価データ（日時をインデックスに持ち、Open, High, Low, Close, Adj Close, Volumeのカラムを含む）

#### 補足

- 取得したデータはそのまま表示されます。

---

### 3.2 日本経済新聞のニューススクレイピング

#### 目的

日本経済新聞のトップページからニュース記事のタイトルとURLを取得し、一覧表示します。

#### 入力

- なし（固定URL `"https://www.nikkei.com/"` を使用）

#### 処理内容

1. `requests`ライブラリを用いて、日経新聞トップページのHTMLを取得します。
2. `BeautifulSoup`でHTMLをパースし、ニュース記事のリンク要素を抽出します。
   - 抽出対象は`<a>`タグでクラス名が`k-card__title-link`の要素です。
3. 各記事のタイトルテキストとリンクURLを取得し、URLが相対パスの場合は絶対パスに変換します。
4. タイトルとURLをそれぞれリストに格納します。
5. 取得したリストを用いて`pandas.DataFrame`を作成します。

#### 出力

- `df` : pandas.DataFrame  
  カラムは`news_title`（ニュースタイトル）、`news_url`（ニュースURL）

#### 補足

- コメントアウトされた別のスクレイピング方法もコード内に記載されていますが、実際に使用されているのは`k-card__title-link`クラスを対象とした方法です。
- 取得結果はコンソールに表示されます。

---

### 3.3 機械学習モデルの生成・学習・予測および可視化

#### 3.3.1 回帰木モデルによる層化データの生成と学習

##### 目的

層化変数を持つ回帰問題のデータを生成し、決定木回帰モデルで学習・予測を行い、層化の有無によるデータの違いを可視化します。

##### 入力

- なし（乱数シード固定でデータ生成）

##### 処理内容

1. 乱数シードを固定（`np.random.seed(0)`）し、1000件のデータを生成します。
2. 特徴量
   - `X1` : カテゴリ変数（'A'または'B'）を層化変数として生成（50%ずつ）
   - `X2` : `X1`のカテゴリごとに異なる正規分布（'A': 平均10, 'B': 平均20）から生成
3. 目的変数`Y`は`X1`のカテゴリごとに異なる線形関係にノイズを加えて生成
4. `X1`はワンホットエンコーディング（`pd.get_dummies`）で数値化し、`X2`と合わせて説明変数とします。
5. データを訓練データとテストデータに分割（8:2）
6. `DecisionTreeRegressor`モデルを学習し、テストデータで予測を行います。
7. matplotlibとseabornを用いて、層化なし・ありの`X2`と`Y`の散布図を並べて表示します。

##### 出力

- 学習済みモデル
- テストデータに対する予測値（`Y_pred`）
- 可視化グラフ（散布図）

##### 補足

- 層化変数`X1`による色分けでデータの分布の違いを視覚的に確認できます。

---

#### 3.3.2 分類木モデルによる層化データの生成と学習

##### 目的

年齢層と予防接種の有無を説明変数とし、重症化の有無を目的変数とした分類問題のデータを生成し、決定木分類モデルで学習・予測を行い、層化の有無による違いを可視化します。

##### 入力

- なし（乱数シード固定でデータ生成）

##### 処理内容

1. 乱数シードを固定（`np.random.seed(0)`）し、5000件のデータを生成します。
2. 特徴量
   - `age` : 年齢層（0: 若年層, 1: 高齢層）を確率0.6/0.4で生成
   - `vaccinated` : 予防接種の有無（0: 受けない, 1: 受ける）を確率0.5/0.5で生成
3. 各グループ（年齢層×接種有無）ごとに異なる確率で重症化（0/1の二項分布）を生成
4. 生成したデータを`pandas.DataFrame`にまとめます。
5. 説明変数`age`と`vaccinated`、目的変数`severity`で訓練データとテストデータに分割（8:2）
6. `DecisionTreeClassifier`モデルを学習し、テストデータで予測を行います。
7. matplotlibとseabornを用いて、層化なし・ありの`vaccinated`と`severity`の関係を棒グラフで並べて表示します。

##### 出力

- 学習済みモデル
- テストデータに対する予測値（`Y_pred`）
- 可視化グラフ（棒グラフ）

##### 補足

- 年齢層による層化で、予防接種の効果（重症化率の違い）を視覚的に比較できます。

---

## 4. 変数一覧

| 変数名            | 型               | 説明                                         |
|-------------------|------------------|----------------------------------------------|
| `ticker`          | str              | 取得対象の株式銘柄コード                      |
| `data`            | pandas.DataFrame  | 株価データ                                   |
| `elements_title`  | list[str]        | スクレイピングで取得したニュースタイトルのリスト |
| `elements_url`    | list[str]        | スクレイピングで取得したニュースURLのリスト  |
| `df`              | pandas.DataFrame  | ニュースタイトルとURLのデータフレーム         |
| `X1`              | numpy.ndarray    | 層化カテゴリ変数（'A'/'B'）                   |
| `X2`              | numpy.ndarray    | 連続特徴量                                   |
| `Y`               | numpy.ndarray    | 目的変数（回帰値）                            |
| `data` (機械学習用) | pandas.DataFrame  | 機械学習用の特徴量と目的変数を含むデータフレーム |
| `X`               | pandas.DataFrame  | 説明変数（カテゴリ変数はダミー変数化済み）     |
| `Y`               | pandas.Series    | 目的変数                                     |
| `X_train`, `X_test`, `Y_train`, `Y_test` | pandas.DataFrame/Series | 訓練・テストデータ分割                         |
| `model`           | sklearnモデル     | 学習済み決定木モデル                          |
| `Y_pred`          | numpy.ndarray    | テストデータに対する予測値                     |
| `age`             | numpy.ndarray    | 年齢層（0:若年層,1:高齢層）                   |
| `vaccinated`      | numpy.ndarray    | 予防接種の有無（0:受けない,1:受ける）          |
| `severity`        | numpy.ndarray    | 重症化の有無（0/1）                           |
| `data` (分類用)   | pandas.DataFrame  | 年齢層・予防接種・重症化のデータフレーム       |

---

## 5. 処理の流れ

1. **株価データの取得**  
   - `ticker`を指定し、`yf.download`で株価データを取得し表示。

2. **ニューススクレイピング**  
   - `get_nikkei_news()`関数を呼び出し、日経新聞トップページからニュースタイトルとURLを抽出。  
   - DataFrameにまとめて表示。

3. **回帰木モデルの学習・可視化**  
   - 層化変数を持つ回帰データを生成。  
   - 決定木回帰モデルを学習・予測。  
   - 層化の有無で散布図を比較表示。

4. **分類木モデルの学習・可視化**  
   - 年齢層・予防接種・重症化の分類データを生成。  
   - 決定木分類モデルを学習・予測。  
   - 層化の有無で棒グラフを比較表示。

---

## 6. 注意点・補足

- スクレイピング対象のHTML構造が変わると、クラス名やセレクタが変わり、正常に動作しなくなる可能性があります。
- `yfinance`のAPI仕様変更や通信環境により、株価データの取得に失敗する場合があります。
- 乱数シードを固定しているため、データ生成は再現性があります。
- 可視化はJupyter NotebookやPython実行環境での表示を想定しています。
- コメントアウトされたスクレイピングの別案は参考情報として残されています。

---

以上が本プログラムの詳細設計書となります。ご不明点がございましたらお知らせください。