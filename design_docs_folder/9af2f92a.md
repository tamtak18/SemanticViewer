# 詳細設計書

本設計書は、Pythonコードに基づく新型コロナウイルス感染症の重症化リスク予測モデルの構築および解析処理について、詳細に説明いたします。本コードは、シミュレーションデータの生成から、データの可視化、機械学習モデル（決定木、LightGBM、XGBoost）による重症化予測、モデル評価、及び可視化までを一連の流れとして実装しています。

---

## 1. 概要

本プログラムは、以下の目的で構成されています。

- 疫学的要因を考慮した重症化リスクのシミュレーションデータを生成する。
- 生成したデータの特徴量と重症化率の関係を可視化する。
- 決定木、LightGBM、XGBoostの3種類の機械学習モデルを用いて重症化予測モデルを構築し、ハイパーパラメータチューニングを行う。
- 各モデルの性能評価を行い、混同行列や分類レポートを出力する。
- 決定木モデルの可視化を行う。

---

## 2. 使用ライブラリ

| ライブラリ名           | 用途                                     |
|-----------------------|-----------------------------------------|
| numpy                 | 数値計算、乱数生成                       |
| pandas                | データフレーム操作                       |
| matplotlib.pyplot     | グラフ描画                               |
| seaborn               | 高度なデータ可視化                       |
| sklearn.model_selection | データ分割、グリッドサーチによるハイパーパラメータチューニング |
| sklearn.tree          | 決定木モデルの構築                       |
| sklearn.metrics       | モデル評価指標                           |
| graphviz              | 決定木の可視化                           |
| dtreeviz              | 決定木の詳細可視化                       |
| lightgbm              | LightGBMモデルの構築                     |
| xgboost               | XGBoostモデルの構築                      |

---

## 3. 処理の流れ詳細

### 3.1 データ生成

#### 3.1.1 乱数シードの固定

- `np.random.seed(0)`により、乱数のシードを固定し、実行毎に同じ結果が得られるようにしています。

#### 3.1.2 サンプル数設定

- `n_samples = 10000`で、1万件のサンプルデータを生成します。

#### 3.1.3 各特徴量の生成

| 特徴量名       | 内容・生成方法                                                                                 |
|----------------|----------------------------------------------------------------------------------------------|
| Age            | 20歳から80歳の範囲で一様ランダムに整数値を生成（`np.random.randint(20, 80, n_samples)`）       |
| Vaccinated     | 年齢に応じてワクチン接種確率を計算し、二項分布で接種有無を生成。高齢者ほど接種率が高い設定。    |
| Gender         | 性別を0（女性）または1（男性）でランダムに生成                                               |
| Comorbidities  | 基礎疾患の有無を0（無し）または1（有り）で、70%が無し、30%が有りの確率で生成                   |
| Smoking        | 喫煙の有無を0（非喫煙者）または1（喫煙者）で、80%が非喫煙者、20%が喫煙者の確率で生成           |
| Obesity        | 肥満の有無を0（非肥満）または1（肥満）で、70%が非肥満、30%が肥満の確率で生成                   |
| Hypoxia        | 低酸素血症の有無を0（正常）または1（低酸素血症）で、90%が正常、10%が低酸素血症の確率で生成       |

#### 3.1.4 重症化率の計算

- 年齢に基づく基本重症化率を設定し、基礎疾患、喫煙、肥満、低酸素血症、性別の影響を加味して重症化率を調整します。
- ワクチン接種の効果として、重症化率を50%減少させる係数を掛けています。
- 最終的に重症化率は0から1の範囲にクリップされます。

#### 3.1.5 重症化の有無の決定

- 重症化率を確率として、二項分布により重症化の有無（0:非重症、1:重症）を決定します。

#### 3.1.6 データフレーム作成

- 生成した特徴量と重症化の有無を`pandas.DataFrame`にまとめます。
- 年齢を6つの層（20-30歳、30-40歳、...、70-80歳）に分割し、`AgeGroup`列を追加します。

---

### 3.2 データ保存・読み込み

- 生成したデータをCSVファイル（`generated_data_fixed.csv`）として保存します。
- 後続の解析ではCSVファイルからデータを読み込みます。

---

### 3.3 データ可視化

#### 3.3.1 各要因と重症化率の関係

- `Comorbidities`, `Smoking`, `Obesity`, `Hypoxia`, `Gender`, `Vaccinated`の各要因について、年齢層ごとに重症化率の平均を算出し、棒グラフで可視化します。
- 年齢層ごとの傾向や要因ごとの重症化率の違いを視覚的に把握できます。

#### 3.3.2 ワクチン接種と重症化率の関係

- 年齢層を無視した場合のワクチン接種有無別の重症化率を棒グラフで表示します。
- 年齢層ごとにワクチン接種有無別の重症化率を折れ線グラフで表示し、年齢とワクチン接種の相互作用を確認します。

#### 3.3.3 クロス集計表の作成

- `AgeGroup`と`Vaccinated`の2軸で重症化率の平均を集計し、表形式で出力します。

---

### 3.4 機械学習モデル構築・評価

#### 3.4.1 特徴量とターゲットの設定

- 特徴量：`Age`, `Vaccinated`, `Gender`, `Comorbidities`, `Smoking`, `Obesity`, `Hypoxia`
- ターゲット：`Severe`（重症化の有無）

#### 3.4.2 データ分割

- 学習用データとテスト用データに7:3の割合で分割します（`random_state=42`で再現性確保）。

#### 3.4.3 モデル別処理

##### 3.4.3.1 決定木（Decision Tree）

- ハイパーパラメータ候補：
  - `max_depth`: [3, 5, 7, 10]
  - `min_samples_split`: [2, 5, 10]
- 5分割交差検証でF1スコアを評価指標にグリッドサーチを実施。
- 最良モデルでテストデータを予測し、精度、混同行列、分類レポートを出力。
- 混同行列をヒートマップで可視化。
- 決定木の構造を`graphviz`および`dtreeviz`で可視化。

##### 3.4.3.2 LightGBM

- ハイパーパラメータ候補：
  - `num_leaves`: [31, 50, 70]
  - `max_depth`: [-1, 10, 20]
  - `learning_rate`: [0.01, 0.1, 0.2]
  - `n_estimators`: [100, 200, 500]
- 5分割交差検証でF1スコアを評価指標にグリッドサーチを実施。
- 最良モデルでテストデータを予測し、精度、混同行列、分類レポートを出力。
- 混同行列をヒートマップで可視化。

##### 3.4.3.3 XGBoost

- ハイパーパラメータ候補：
  - `max_depth`: [3, 5, 7, 10]
  - `learning_rate`: [0.01, 0.1, 0.2]
  - `n_estimators`: [100, 200, 500]
  - `subsample`: [0.8, 1.0]
- 5分割交差検証でF1スコアを評価指標にグリッドサーチを実施。
- 最良モデルでテストデータを予測し、精度、混同行列、分類レポートを出力。
- 混同行列をヒートマップで可視化。
- 予測結果と実際の重症化率を散布図で比較（年齢とワクチン接種の有無を色・形で区別）。

---

## 4. 主要関数・処理説明

| 処理内容                         | 詳細説明                                                                                      |
|---------------------------------|---------------------------------------------------------------------------------------------|
| `np.random.randint`              | 指定範囲の整数をランダムに生成                                                               |
| `np.random.binomial`             | 二項分布に従う乱数を生成し、確率的に0/1を決定                                               |
| `np.clip`                       | 配列の値を指定範囲内に制限                                                                   |
| `pd.DataFrame`                  | データを表形式で管理                                                                         |
| `pd.cut`                       | 連続変数を区間に分割しカテゴリ変数化                                                         |
| `groupby` + `mean`              | グループごとの平均値を算出                                                                   |
| `sns.barplot`                   | 棒グラフ描画                                                                                 |
| `sns.lineplot`                  | 折れ線グラフ描画                                                                             |
| `train_test_split`              | データを学習用とテスト用に分割                                                               |
| `GridSearchCV`                  | グリッドサーチによるハイパーパラメータ最適化                                                 |
| `DecisionTreeClassifier`        | 決定木分類器                                                                                 |
| `LGBMClassifier`                | LightGBM分類器                                                                              |
| `XGBClassifier`                 | XGBoost分類器                                                                              |
| `accuracy_score`                | 正解率計算                                                                                   |
| `confusion_matrix`              | 混同行列作成                                                                               |
| `classification_report`         | 精度、再現率、F1スコア等の詳細レポート                                                       |
| `export_graphviz` + `graphviz` | 決定木の構造をDOT形式で出力し可視化                                                         |
| `dtreeviz`                     | 決定木の詳細な可視化                                                                         |

---

## 5. データ構造

| カラム名       | データ型 | 内容説明                             | 備考                         |
|----------------|----------|------------------------------------|------------------------------|
| Age            | int      | 年齢                               | 20〜80歳                     |
| Vaccinated     | int      | ワクチン接種有無                   | 0:未接種、1:接種             |
| Gender         | int      | 性別                               | 0:女性、1:男性               |
| Comorbidities  | int      | 基礎疾患の有無                     | 0:無し、1:有り               |
| Smoking        | int      | 喫煙の有無                        | 0:非喫煙者、1:喫煙者        |
| Obesity        | int      | 肥満の有無                        | 0:非肥満、1:肥満            |
| Hypoxia        | int      | 低酸素血症の有無                  | 0:正常、1:低酸素血症        |
| Severe         | int      | 重症化の有無                      | 0:非重症、1:重症            |
| AgeGroup       | category | 年齢層                            | 20-30, 30-40, ..., 70-80歳  |

---

## 6. 注意事項・補足

- シミュレーションデータは実際の疫学データを模したものであり、実データとは異なる可能性があります。
- ハイパーパラメータの範囲は例示的なものであり、実際のモデル性能向上のためには更なる調整が必要です。
- 可視化は解析の理解を助けるためのものであり、必要に応じて保存やレポートへの組み込みが可能です。
- 決定木の可視化には`graphviz`と`dtreeviz`の両方を使用しており、用途に応じて使い分けが可能です。
- XGBoostの`use_label_encoder=False`および`eval_metric='logloss'`は警告回避のための設定です。

---

## 7. まとめ

本プログラムは、疫学的要因を考慮した重症化リスクのシミュレーションデータを生成し、複数の機械学習モデルで重症化予測を行う一連の処理を実装しています。データの可視化やモデルの評価、決定木の可視化を通じて、重症化リスクの理解と予測精度の向上を目指しています。今後は実データへの適用やモデルの高度化、さらなる解析を進めることが可能です。

---

以上で詳細設計書の説明を終わります。ご不明点や追加のご要望がございましたらお知らせください。