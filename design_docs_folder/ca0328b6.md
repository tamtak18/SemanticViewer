# 詳細設計書

本ドキュメントは、Pythonコードの詳細設計書です。本コードは、架空の医療データを生成し、重症化予測モデル（決定木、LightGBM、XGBoost）を構築・評価・可視化する一連の処理を実装しています。以下に各処理の目的、入力・出力、処理内容、使用ライブラリ、注意点などを丁寧に説明いたします。

---

## 1. ライブラリのインポート

### 概要
データ生成、前処理、機械学習モデル構築、評価、可視化に必要なライブラリをインポートします。

### 主なライブラリ
- `numpy`：数値計算、乱数生成
- `pandas`：データフレーム操作
- `matplotlib.pyplot`、`seaborn`：グラフ描画
- `sklearn`：機械学習モデル、前処理、評価指標、グリッドサーチ
- `lightgbm`、`xgboost`：勾配ブースティングモデル
- `graphviz`、`dtreeviz`：決定木の可視化

---

## 2. データ生成

### 目的
架空の患者データを生成し、重症化の有無を含むデータセットを作成します。

### 入力
- サンプル数：10,000件
- 年齢範囲：20歳〜80歳

### 出力
- `pandas.DataFrame`形式のデータセット（特徴量7項目＋ターゲット1項目）

### 処理内容
1. 年齢を20〜80歳の整数でランダム生成。
2. 年齢に応じてワクチン接種確率を設定し、二項分布で接種有無を生成。
3. 性別（0:女性、1:男性）、基礎疾患、喫煙、肥満、低酸素血症の有無を確率に基づきランダム生成。
4. 年齢と各因子の影響を考慮した重症化率を計算し、ワクチン接種の効果で重症化率を減少させる。
5. 重症化率に基づき重症化の有無を二項分布で決定。
6. 以上の情報をデータフレームにまとめる。
7. 年齢層（20-30歳、30-40歳、...）で層化した列を追加。
8. CSVファイルに保存。

### 注意点
- 乱数シードを固定し、再現性を確保。
- 重症化率は0〜1にクリップしている。
- 年齢層の区切りは`pd.cut`で設定。

---

## 3. データの可視化

### 目的
各因子と重症化率の関係を年齢層別に可視化し、傾向を把握します。

### 入力
- 生成したデータフレーム

### 出力
- 各因子ごとの重症化率棒グラフ（SVG形式で保存）
- ワクチン接種有無と重症化率の関係棒グラフ（年齢層無視）

### 処理内容
- 因子ごとにグループ化し、年齢層別の重症化率平均を計算。
- `seaborn.barplot`で棒グラフを作成し、タイトル・軸ラベルを設定。
- SVGファイルとして保存し、画面にも表示。

### 注意点
- 出力ディレクトリは`./decision_tree_output/`で固定。
- 因子は`Comorbidities`, `Smoking`, `Obesity`, `Hypoxia`, `Gender`, `Vaccinated`の6項目。

---

## 4. データ前処理（機械学習用）

### 目的
機械学習モデルに入力するための特徴量とターゲットを分離し、トレーニング・テストデータに分割します。

### 入力
- 生成データフレーム（`AgeGroup`列は削除）

### 出力
- `X_train`, `X_test`, `y_train`, `y_test`（訓練・テストデータ）

### 処理内容
- `AgeGroup`列を削除。
- `Severe`列をターゲット変数とし、それ以外を特徴量とする。
- `train_test_split`で80%訓練、20%テストに分割。

---

## 5. オーバーサンプリング（少数クラスの補正）

### 目的
重症化クラス（少数クラス）のサンプル数を増やし、クラス不均衡を解消します。

### 入力
- トレーニングデータ（`X_train`, `y_train`）

### 出力
- バランス調整済みトレーニングデータ（`X_train_balanced`, `y_train_balanced`）

### 処理内容
- クラス0（非重症）とクラス1（重症）に分割。
- `resample`を用いてクラス1をクラス0と同数まで複製。
- 両クラスを結合し、バランスの取れたデータセットを作成。

---

## 6. 決定木モデルの構築とハイパーパラメータチューニング

### 目的
決定木モデルを構築し、グリッドサーチで最適なハイパーパラメータを探索します。

### 入力
- バランス調整済みトレーニングデータ

### 出力
- 最適パラメータ
- 最良モデル（`best_clf_dt`）

### 処理内容
- `Pipeline`に決定木分類器をセット。
- ハイパーパラメータグリッドを設定（`criterion`, `splitter`, `max_depth`, `min_samples_split`, `min_samples_leaf`）。
- `GridSearchCV`で5分割交差検証を実施し、精度（accuracy）で評価。
- 最適パラメータを取得し、最良モデルを保存。

---

## 7. モデル評価と混同行列の可視化

### 目的
テストデータに対するモデルの性能を評価し、混同行列を可視化します。

### 入力
- テストデータ（`X_test`, `y_test`）
- 最良決定木モデル

### 出力
- 精度（accuracy）
- 分類レポート（precision, recall, f1-score）
- 混同行列のヒートマップ（SVG保存）

### 処理内容
- テストデータで予測を実施。
- `confusion_matrix`, `accuracy_score`, `classification_report`で評価。
- 混同行列を注釈付きヒートマップで描画。
- SVG形式で保存し、画面表示。

---

## 8. 特徴量重要度の可視化

### 目的
決定木モデルの特徴量重要度を棒グラフで可視化します。

### 入力
- 最良決定木モデル
- バランス調整済みトレーニングデータの特徴量名

### 出力
- 特徴量重要度棒グラフ（SVG保存）

### 処理内容
- `feature_importances_`属性から重要度を取得。
- 重要度を降順に並べ替え。
- 横棒グラフを描画し、SVG保存。

---

## 9. 決定木の深さを変えたモデルの構築と評価

### 目的
決定木の`max_depth`を1から14まで変化させ、モデルの性能を比較・可視化します。

### 入力
- バランス調整済みトレーニングデータ
- テストデータ

### 出力
- 各深さでの精度、精度指標（precision, recall, f1-score）
- 決定木のSVG可視化ファイル
- 混同行列SVGファイル
- 精度の折れ線グラフ（SVG保存）
- 評価指標のExcelファイル

### 処理内容
- ループで`max_depth`を変えながら決定木を学習。
- トレーニング・テストデータで予測し、精度を計算。
- 混同行列を描画しSVG保存。
- 決定木をGraphvizで可視化しSVG保存。
- 精度を折れ線グラフで表示・保存。
- 評価指標をDataFrameにまとめExcel保存。

---

## 10. オーバーサンプリングなしの決定木モデル構築

### 目的
オーバーサンプリングを行わずに決定木モデルを構築し、性能を比較します。

### 入力
- 元のデータセット（CSVから読み込み）

### 出力
- 最適パラメータ
- テストデータに対する評価結果（精度、分類レポート）
- 混同行列のヒートマップ表示
- 決定木のSVG可視化ファイル

### 処理内容
- データを読み込み、`AgeGroup`列を削除。
- 特徴量とターゲットを分離し、訓練・テスト分割。
- パイプラインに標準化と決定木を設定。
- グリッドサーチで最適パラメータ探索。
- テストデータで評価し、結果を表示。
- 混同行列をヒートマップで表示。
- 決定木をGraphvizで可視化しSVG保存。

---

## 11. 決定木の高度な可視化（dtreeviz）

### 目的
`dtreeviz`ライブラリを用いて決定木を詳細に可視化します。

### 入力
- 最良決定木モデル
- トレーニングデータ

### 出力
- 決定木のSVGファイル
- 可視化の表示

### 処理内容
- `dtreeviz`でモデルとデータを渡し、可視化オブジェクトを生成。
- SVG形式で保存し、画面に表示。

---

## 12. LightGBMモデルの構築と評価（オーバーサンプリングあり・なし）

### 目的
LightGBMを用いて重症化予測モデルを構築し、ハイパーパラメータチューニングと評価を行います。

### 入力
- データセット（CSVから読み込み）
- オーバーサンプリングの有無で処理を分ける

### 出力
- 最適パラメータ
- テストデータに対する評価結果（精度、分類レポート）

### 処理内容
- オーバーサンプリングありの場合は少数クラスを複製しバランス調整。
- パイプラインに標準化とLightGBM分類器を設定。
- グリッドサーチでパラメータ探索。
- テストデータで予測・評価。
- 結果をコンソールに表示。

---

## 13. XGBoostモデルの構築と評価

### 目的
XGBoostを用いて重症化予測モデルを構築し、ハイパーパラメータチューニングと評価を行います。

### 入力
- 生成データセット

### 出力
- 最適パラメータ
- テストデータに対する評価結果（精度、分類レポート）
- 混同行列ヒートマップ
- 予測結果と実際の重症化率の散布図

### 処理内容
- データをトレーニング・テストに分割。
- グリッドサーチで`max_depth`, `learning_rate`, `n_estimators`, `subsample`を探索。
- 最良モデルで予測し評価。
- 混同行列をヒートマップで表示。
- 予測結果と実際の重症化率を年齢・ワクチン接種有無別に散布図で可視化。

---

## 14. まとめ

本コードは、架空の医療データを生成し、複数の機械学習モデル（決定木、LightGBM、XGBoost）を用いて重症化予測を行う一連の処理を実装しています。データの生成から前処理、モデル構築、ハイパーパラメータチューニング、評価、可視化までを包括的に実施し、モデルの性能比較や特徴量の重要度分析も行っています。

---

# 付録：主な変数・ファイル一覧

| 変数名・ファイル名                  | 内容・役割                                   |
|-----------------------------------|--------------------------------------------|
| `df`                              | 生成した患者データのDataFrame               |
| `X_train`, `X_test`, `y_train`, `y_test` | 訓練・テストデータ                         |
| `X_train_balanced`, `y_train_balanced` | オーバーサンプリング後の訓練データ         |
| `best_clf_dt`                     | 決定木の最良モデル                           |
| `best_clf_lgb`                    | LightGBMの最良モデル                         |
| `best_clf_xgb`                    | XGBoostの最良モデル                          |
| `./decision_tree_input/generated_data_fixed.csv` | 生成データのCSVファイル                     |
| `./decision_tree_output/`         | 可視化画像や評価結果の保存ディレクトリ       |
| `confusion_matrix.svg`            | 混同行列のSVGファイル                        |
| `feature_importance.svg`          | 特徴量重要度の棒グラフSVGファイル            |
| `decision_tree_depth{n}.svg`      | 深さnの決定木の可視化SVGファイル             |
| `accuracy_vs_max_depth.svg`       | 決定木深さと精度の関係グラフSVGファイル       |
| `evaluation_metrics.xlsx`         | 深さごとの評価指標をまとめたExcelファイル     |

---

以上