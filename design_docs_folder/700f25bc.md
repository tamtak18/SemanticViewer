# Pythonコード詳細設計書

本設計書は、提示されたPythonコードの詳細設計を記述したものです。コードは主にプロ野球の打撃成績データの収集、加工、分析、機械学習モデルによる予測、評価、可視化を行う一連の処理で構成されています。以下に各処理の目的、機能、処理手順、入出力、使用ライブラリなどを丁寧に説明いたします。

---

## 1. データ収集および前処理

### 1.1 目的
2012年から2023年までのプロ野球打撃成績データをWebサイトから取得し、CSVファイルとして保存すること。

### 1.2 使用ライブラリ
- `os`：フォルダ作成、ファイルパス操作
- `requests`：WebページのHTML取得
- `BeautifulSoup`（`bs4`）：HTMLパース
- `pandas`：データフレーム操作
- `datetime`：ファイル名に付加するタイムスタンプ生成

### 1.3 処理概要
1. 保存先フォルダ`./プロ野球データ打撃成績`を作成（存在しない場合）。
2. 2012年から2023年までの各年度について、4つのURL（パ・セ両リーグのトップページおよび打撃成績ページ）からHTMLを取得。
3. HTMLから打撃成績のテーブル（クラス名`table-sticky`）を抽出。
4. テーブルのヘッダーと行データを取得し、`pandas.DataFrame`に変換。
5. 二重ヘッダーの除去、選手名の不要な数字や空白の削除、年度カラムの追加、不要な「調子」カラムの削除を実施。
6. 全年度・全URLのデータを結合し、選手名・年度でソート。
7. タイムスタンプ付きのCSVファイルとして保存。

### 1.4 入出力
- 入力：WebサイトのHTMLページ
- 出力：`./プロ野球データ打撃成績/batting_stats_2012_2023_YYYYMMDDHHMMSS.csv`

---

## 2. 翌年・昨年のOPSおよび本塁打データの追加

### 2.1 目的
CSVファイルの打撃成績データに対して、各選手の前年・翌年のOPS（出塁率＋長打率）と本塁打数を追加し、Excelファイルとして保存すること。

### 2.2 使用ライブラリ
- `pandas`

### 2.3 処理概要
1. CSVファイルを読み込み。
2. 「翌年OPS」「昨年OPS」「翌年本塁打」「昨年本塁打」の4カラムを空で追加。
3. 各行について、同じ選手の翌年・前年のデータを検索し、該当するOPSと本塁打を該当カラムにセット。
4. 欠損値は0で埋める。
5. OPSの欠損値表記「.---」を「.000」に置換。
6. Excelファイルとして保存。

### 2.4 入出力
- 入力：`./プロ野球データ打撃成績/batting_stats_2012_2023.csv`
- 出力：`./プロ野球データ打撃成績/batting_stats_昨年翌年OPS本塁打_2012_2023.xlsx`

---

## 3. データの基本情報および統計量の確認

### 3.1 目的
Excelファイルのデータに対して、各カラムの非欠損数やデータ型、統計量を確認し、コンソールに表示すること。

### 3.2 使用ライブラリ
- `pandas`

### 3.3 処理概要
1. Excelファイルを読み込み。
2. 各カラムの非欠損数、データ型をまとめたDataFrameを作成。
3. `describe()`メソッドで統計量を取得。
4. コンソールに表示。

---

## 4. データの基本情報および統計量のExcel保存

### 4.1 目的
データの基本情報と統計量をExcelファイルに保存すること。

### 4.2 使用ライブラリ
- `pandas`
- `os`

### 4.3 処理概要
1. Excelファイルを読み込み。
2. 基本情報（カラム名、非欠損数、データ型）をDataFrameにまとめる。
3. 統計量を取得。
4. 新規フォルダ`./プロ野球データ打撃成績_output/`を作成（存在しない場合）。
5. 基本情報と統計量を別シートに分けてExcelファイルに保存。

### 4.4 入出力
- 入力：`./プロ野球データ打撃成績/batting_stats_昨年翌年OPS本塁打selected_2012_2023.xlsx`
- 出力：`./プロ野球データ打撃成績_output/パリーグデータ_summary_昨年翌年OPS本塁打selected_2012_2023.xlsx`

---

## 5. ペアプロットによる特徴量の相関分析

### 5.1 目的
打撃成績の特徴量間の相関をペアプロットで可視化し、相関係数を表示すること。

### 5.2 使用ライブラリ
- `pandas`
- `seaborn`
- `matplotlib`
- `scipy.stats`（`pearsonr`）
- `os`

### 5.3 処理概要
1. Excelファイルを読み込み。
2. 2023年のデータを除外。
3. 「翌年OPS」が0の行、「打席数」が0の行を除外。
4. 使用する特徴量を選択（例：打率から三振までのカラムと翌年本塁打）。
5. ペアプロットを作成し、下三角部分にピアソン相関係数を表示。
6. 日本語フォントを設定し、マーカーや線の色を白黒印刷に適したものに調整。
7. グラフを画面表示し、SVGおよびJPG形式で保存。

### 5.4 入出力
- 入力：`./プロ野球データ打撃成績/batting_stats_翌年OPS本塁打selected_2012_2023.xlsx`
- 出力：`./プロ野球データ打撃成績_output/pairplot_翌年OPS本塁打.svg`、`pairplot_翌年OPS本塁打.jpg`

---

## 6. 決定木モデルによる翌年本塁打予測（複数バージョン）

### 6.1 目的
決定木回帰モデルを用いて、打撃成績から翌年の本塁打数を予測し、モデルの性能評価と特徴量重要度の可視化を行うこと。

### 6.2 使用ライブラリ
- `pandas`
- `numpy`
- `matplotlib`
- `seaborn`
- `sklearn.tree.DecisionTreeRegressor`
- `sklearn.metrics`（`mean_squared_error`, `r2_score`）
- `scipy.stats`（`pearsonr`）
- `os`
- `matplotlib.font_manager`
- `matplotlib.rc`

### 6.3 処理概要
1. Excelファイルを読み込み。
2. 2023年のデータを除外。
3. 特徴量（打率～三振）とターゲット（翌年本塁打）を設定。
4. 学習データ（2012～2018年）、検証データ（2019～2020年）、テストデータ（2021～2022年）に分割。
5. 学習・検証・テストデータをExcelに保存。
6. `max_depth`を1～20まで変化させて決定木モデルを学習し、検証データでR²スコアを計算。
7. `max_depth`とR²スコアの関係をグラフ化し保存。
8. 最適な`max_depth`（例：4）でモデルを学習し、検証データで予測。
9. 特徴量重要度を棒グラフで可視化し保存。
10. テストデータの予測値と実測値の散布図を作成し保存。
11. 学習データの予測値と実測値の散布図も作成し保存。
12. MSE、R²、相関係数を計算し、テキストファイルに保存。

### 6.4 入出力
- 入力：`./プロ野球データ打撃成績/batting_stats_昨年翌年OPS本塁打selected_2012_2023.xlsx`
- 出力：
  - 学習・検証・テストデータExcelファイル
  - max_depthとR²スコアグラフ（SVG）
  - 特徴量重要度グラフ（SVG）
  - 予測値vs実測値散布図（SVG）
  - モデル評価結果テキストファイル

---

## 7. 勾配ブースティング（GradientBoostingRegressor）モデルによる予測

### 7.1 目的
決定木より高性能な勾配ブースティング回帰モデルを用いて、翌年本塁打数を予測し、性能評価を行うこと。

### 7.2 使用ライブラリ
- `sklearn.ensemble.GradientBoostingRegressor`
- その他は決定木モデルと同様

### 7.3 処理概要
決定木モデルと同様の流れで、モデルを`GradientBoostingRegressor`に置き換え、`max_depth`を変化させて性能を評価。結果をグラフ化し保存。

---

## 8. ランダムフォレスト（RandomForestRegressor）モデルによる予測

### 8.1 目的
ランダムフォレスト回帰モデルを用いて翌年本塁打数を予測し、性能評価を行うこと。

### 8.2 使用ライブラリ
- `sklearn.ensemble.RandomForestRegressor`
- その他は決定木モデルと同様

### 8.3 処理概要
決定木モデルと同様の流れで、モデルを`RandomForestRegressor`に置き換え、`max_depth`を変化させて性能を評価。結果をグラフ化し保存。

---

## 9. LightGBM（LGBMRegressor）モデルによる予測

### 9.1 目的
LightGBM回帰モデルを用いて翌年本塁打数を予測し、性能評価を行うこと。

### 9.2 使用ライブラリ
- `lightgbm.LGBMRegressor`
- その他は決定木モデルと同様

### 9.3 処理概要
決定木モデルと同様の流れで、モデルを`LGBMRegressor`に置き換え、`max_depth`を変化させて性能を評価。結果をグラフ化し保存。

---

## 10. 共通の補足事項

- 日本語フォント設定は環境に応じて`Hiragino Sans`や`Meiryo`を使用し、グラフの日本語表示に対応しています。
- 正規化フラグがコード内に存在しますが、デフォルトは`False`であり、正規化処理は実装されていません。
- データの欠損値処理は主に0埋めや文字列置換で対応しています。
- ファイル・フォルダの存在チェックと作成は`os.makedirs(..., exist_ok=True)`で安全に行っています。
- モデル評価指標はMSE（平均二乗誤差）、R²（決定係数）、ピアソン相関係数を用いています。
- グラフはSVG形式とJPG形式で保存し、用途に応じて使い分け可能です。

---

# まとめ

本コードは、プロ野球の打撃成績データをWebから収集し、加工・分析を行い、複数の機械学習モデルで翌年の本塁打数を予測する一連の処理を実装しています。データの前処理からモデル構築、評価、可視化までを包括的にカバーしており、分析結果はExcelや画像ファイル、テキストファイルとして保存されます。各処理はモジュール化されており、再利用や拡張が容易な設計となっています。

---

以上が提示されたPythonコードの詳細設計書となります。ご不明点や追加のご要望がございましたら、お気軽にお知らせください。