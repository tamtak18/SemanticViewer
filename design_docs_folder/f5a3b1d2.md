# 詳細設計書

---

## 1. 概要

本プログラムは、架空の肺がん発生率データを生成し、喫煙の影響を単純回帰分析および交絡因子（年齢）を制御した多変量回帰分析で評価します。さらに、食事の質や運動習慣を加えた拡張モデルを構築し、喫煙と年齢の相互作用効果も検討します。結果は統計解析の要約とグラフで可視化します。

---

## 2. 使用ライブラリ

| ライブラリ名       | 用途                                     |
|--------------------|------------------------------------------|
| numpy              | データ生成、数値計算                      |
| pandas             | データフレーム操作                        |
| statsmodels.api     | 回帰分析（OLS）                           |
| matplotlib.pyplot   | グラフ描画                               |
| seaborn            | グラフ描画のスタイル向上                  |
| matplotlib.font_manager | 日本語フォント設定                       |

---

## 3. 処理概要

### 3.1 データ生成

- サンプル数は1000件とする。
- 年齢（age）は18歳から80歳の整数の乱数。
- 喫煙（smoking）は30%の確率で1（喫煙者）、70%で0（非喫煙者）の二項分布乱数。
- 食事の質（diet）は1〜3の整数ランク。
- 運動習慣（exercise）は週あたり0〜4回の整数乱数。
- 肺がん発生率（lung_cancer）は以下の式で生成。
  - 初期モデル：`0.1 * age + 3 * smoking + 正規分布ノイズ`
  - 拡張モデル：`0.1 * age + 3 * smoking + 0.5 * diet - 1 * exercise + 正規分布ノイズ`

### 3.2 データフレーム作成

- 生成した各変数をpandasのDataFrameにまとめる。

### 3.3 回帰分析

#### 3.3.1 単純回帰分析

- 目的変数：`lung_cancer`
- 説明変数：`smoking`のみ
- statsmodelsのOLS（最小二乗法）を用いて回帰分析を実施。

#### 3.3.2 交絡因子を制御した回帰分析

- 説明変数に`age`を追加し、`smoking`の影響を年齢の影響を考慮して評価。

#### 3.3.3 拡張モデルによる回帰分析

- 説明変数に`age`, `smoking`, `diet`, `exercise`、および`smoking`と`age`の相互作用項を含める。
- 相互作用項は`smoking * age`で作成。
- 回帰分析を実施し、複数の要因と相互作用の影響を評価。

### 3.4 結果表示

- 各回帰分析の結果をコンソールに表示。
- 回帰係数、標準誤差、t値、p値、決定係数などの統計量を含む。

### 3.5 可視化

- 日本語フォント（メイリオ）を設定し、日本語タイトルや軸ラベルを正しく表示。
- 喫煙と肺がんの関係を散布図と回帰直線で表示。
- 単純回帰モデルと交絡因子制御モデルの比較を左右に並べて表示。
- 散布図は透明度を設定し、データ点の重なりを見やすくしている。

---

## 4. 詳細設計

### 4.1 変数設計

| 変数名                   | 型           | 説明                                   |
|--------------------------|--------------|--------------------------------------|
| N                        | int          | サンプル数（1000）                    |
| age                      | ndarray[int] | 18〜80歳のランダムな年齢データ       |
| smoking                  | ndarray[int] | 0または1の喫煙者フラグ               |
| diet                     | ndarray[int] | 食事の質（1〜3のランク）              |
| exercise                 | ndarray[int] | 週あたりの運動回数（0〜4）            |
| lung_cancer              | ndarray[float] | 肺がん発生率（連続値）               |
| data                     | DataFrame    | 上記変数をまとめたデータフレーム     |
| smoking_age_interaction  | Series       | 喫煙と年齢の相互作用項                |
| model_simple             | RegressionResults | 喫煙のみの単純回帰モデル             |
| model_adjusted           | RegressionResults | 喫煙と年齢を含む多変量回帰モデル     |
| model                   | RegressionResults | 拡張モデル（age, smoking, diet, exercise, interaction） |

### 4.2 関数・処理フロー

| 処理内容                         | 詳細                                                                                  |
|---------------------------------|---------------------------------------------------------------------------------------|
| シード設定                      | `np.random.seed(42)`で乱数の再現性を確保                                            |
| データ生成                      | `np.random`を用いて各変数を生成                                                       |
| データフレーム作成              | `pd.DataFrame`で変数をまとめる                                                        |
| 単純回帰分析                    | `sm.OLS`にて`lung_cancer ~ smoking`のモデルを作成し、`fit()`で推定                   |
| 交絡因子制御回帰分析            | `sm.OLS`にて`lung_cancer ~ smoking + age`のモデルを作成し、`fit()`で推定             |
| 拡張モデル回帰分析              | `sm.OLS`にて`lung_cancer ~ age + smoking + diet + exercise + smoking*age`のモデルを作成し、`fit()`で推定 |
| 回帰結果表示                    | `summary()`で回帰結果の詳細をコンソールに出力                                        |
| 予測値計算                      | `model.predict()`で各モデルの予測値を計算し、データフレームに追加                      |
| フォント設定                    | Windows環境のメイリオフォントを指定し、日本語表示に対応                              |
| 可視化                          | `seaborn.scatterplot`で散布図、`seaborn.lineplot`で回帰直線を描画                     |
| グラフレイアウト調整            | `plt.tight_layout()`でグラフのレイアウトを整える                                      |
| グラフ表示                      | `plt.show()`で画面に表示                                                             |

---

## 5. 入出力仕様

### 5.1 入力

- 本プログラムは外部入力を受け付けません。全て内部で乱数生成によりデータを作成します。

### 5.2 出力

- コンソールに回帰分析結果の統計要約を表示します。
- グラフウィンドウに散布図と回帰直線を表示します。

---

## 6. 注意事項

- フォントパスはWindows環境のメイリオフォントを想定しています。別環境の場合は適宜変更してください。
- 乱数シードを固定しているため、実行毎に同じデータ・結果が得られます。
- 肺がん発生率は架空の数式に基づく合成データであり、実際の疫学的関係を示すものではありません。
- 回帰分析は線形モデルを用いています。非線形性や他の交絡因子は考慮していません。

---

## 7. 改善案・拡張案

- 他の交絡因子（性別、職業など）を追加してモデルを拡張する。
- 非線形モデル（ロジスティック回帰など）を用いて発生率の確率モデル化を行う。
- 実データを用いた検証や交差検証によるモデル評価を実施する。
- 可視化において、年齢ごとの層別解析や3Dプロットを導入する。

---

以上が本プログラムの詳細設計書となります。ご不明点や追加のご要望がありましたらお知らせください。