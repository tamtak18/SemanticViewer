```python
import numpy as np
import pandas as pd
import statsmodels.api as sm
import matplotlib.pyplot as plt
import seaborn as sns

# シードを設定して再現性を確保
np.random.seed(42)

# データの生成
N = 1000  # サンプル数
age = np.random.randint(18, 80, size=N)  # 18歳から80歳までのランダムな年齢データ
smoking = np.random.binomial(1, 0.3, size=N)  # 30%の人が喫煙者
lung_cancer = 0.1 * age + 3 * smoking + np.random.normal(0, 10, size=N)  # 肺がんの発生率（年齢と喫煙の影響を含む）

# データをデータフレームに変換
data = pd.DataFrame({'age': age, 'smoking': smoking, 'lung_cancer': lung_cancer})

# データの表示
print(data.head())  # データの最初の5行を表示

```

       age  smoking  lung_cancer
    0   56        0    -6.573049
    1   69        1     5.079532
    2   46        0    -9.375182
    3   32        1     5.247549
    4   60        0     9.904023
    


```python
# 喫煙と肺がんの単純な回帰分析（交絡因子を制御しない）
model_simple = sm.OLS(data['lung_cancer'], sm.add_constant(data['smoking'])).fit()
print("単純な回帰分析の結果：")
print(model_simple.summary())

# 年齢を交絡因子として制御した回帰分析
model_adjusted = sm.OLS(data['lung_cancer'], sm.add_constant(data[['smoking', 'age']])).fit()
print("\n交絡因子を制御した回帰分析の結果：")
print(model_adjusted.summary())

```

    単純な回帰分析の結果：
                                OLS Regression Results                            
    ==============================================================================
    Dep. Variable:            lung_cancer   R-squared:                       0.022
    Model:                            OLS   Adj. R-squared:                  0.021
    Method:                 Least Squares   F-statistic:                     22.54
    Date:                Sat, 22 Jun 2024   Prob (F-statistic):           2.36e-06
    Time:                        18:51:23   Log-Likelihood:                -3744.7
    No. Observations:                1000   AIC:                             7493.
    Df Residuals:                     998   BIC:                             7503.
    Df Model:                           1                                         
    Covariance Type:            nonrobust                                         
    ==============================================================================
                     coef    std err          t      P>|t|      [0.025      0.975]
    ------------------------------------------------------------------------------
    const          5.0600      0.389     12.993      0.000       4.296       5.824
    smoking        3.3318      0.702      4.748      0.000       1.955       4.709
    ==============================================================================
    Omnibus:                        0.248   Durbin-Watson:                   1.967
    Prob(Omnibus):                  0.883   Jarque-Bera (JB):                0.189
    Skew:                           0.030   Prob(JB):                        0.910
    Kurtosis:                       3.030   Cond. No.                         2.42
    ==============================================================================
    
    Notes:
    [1] Standard Errors assume that the covariance matrix of the errors is correctly specified.
    
    交絡因子を制御した回帰分析の結果：
                                OLS Regression Results                            
    ==============================================================================
    Dep. Variable:            lung_cancer   R-squared:                       0.038
    Model:                            OLS   Adj. R-squared:                  0.036
    Method:                 Least Squares   F-statistic:                     19.45
    Date:                Sat, 22 Jun 2024   Prob (F-statistic):           5.15e-09
    Time:                        18:51:23   Log-Likelihood:                -3736.7
    No. Observations:                1000   AIC:                             7479.
    Df Residuals:                     997   BIC:                             7494.
    Df Model:                           2                                         
    Covariance Type:            nonrobust                                         
    ==============================================================================
                     coef    std err          t      P>|t|      [0.025      0.975]
    ------------------------------------------------------------------------------
    const          1.5130      0.967      1.565      0.118      -0.384       3.410
    smoking        3.3391      0.697      4.794      0.000       1.972       4.706
    age            0.0711      0.018      4.003      0.000       0.036       0.106
    ==============================================================================
    Omnibus:                        0.109   Durbin-Watson:                   1.955
    Prob(Omnibus):                  0.947   Jarque-Bera (JB):                0.100
    Skew:                           0.024   Prob(JB):                        0.951
    Kurtosis:                       2.996   Cond. No.                         163.
    ==============================================================================
    
    Notes:
    [1] Standard Errors assume that the covariance matrix of the errors is correctly specified.
    

この出力は、単純な回帰分析の結果です。喫煙 (`smoking`) が肺がん (`lung_cancer`) に与える影響を調べるために、喫煙のみを独立変数として使用しています。出力の各部分について詳細に解説します。

### モデル全体の概要

- **Dep. Variable**: 従属変数（ここでは `lung_cancer`）
- **Model**: モデルのタイプ（OLS: 最小二乗法）
- **Method**: 使用した方法（Least Squares: 最小二乗法）
- **No. Observations**: 観測数（1000）
- **Df Residuals**: 残差の自由度（998）
- **Df Model**: モデルの自由度（1）

### 回帰の統計量

- **R-squared**: 決定係数（0.022）
  - モデルが従属変数の分散をどの程度説明しているかを示します。ここでは約2.2%しか説明していないことを示しています。
- **Adj. R-squared**: 調整済み決定係数（0.021）
  - モデルの説明力を、モデルの複雑さを考慮して調整したものです。
- **F-statistic**: F検定統計量（22.54）
  - モデル全体が有意かどうかを示す統計量です。
- **Prob (F-statistic)**: F検定のp値（2.36e-06）
  - モデル全体の有意性を示すp値です。ここでは非常に小さい値であり、モデル全体が統計的に有意であることを示しています。

### 回帰係数の詳細

- **coef**: 回帰係数
  - **const**: 定数項（5.0600）
    - 喫煙しない場合の肺がんの予測値です。
  - **smoking**: 喫煙の係数（3.3318）
    - 喫煙が肺がんに与える影響の大きさを示しています。喫煙すると肺がんの値が約3.33増加することを示しています。

- **std err**: 標準誤差
  - **const**: 0.389
  - **smoking**: 0.702
    - 係数の標準誤差を示します。

- **t**: t値
  - **const**: 12.993
  - **smoking**: 4.748
    - 係数の有意性を示すt値です。t値が大きいほど、係数がゼロでない可能性が高いことを示します。

- **P>|t|**: p値
  - **const**: 0.000
  - **smoking**: 0.000
    - 係数の有意性を示すp値です。ここでは、両方とも非常に小さい値であり、係数が統計的に有意であることを示しています。

- **[0.025 0.975]**: 95%信頼区間
  - **const**: [4.296, 5.824]
  - **smoking**: [1.955, 4.709]
    - 係数の95%信頼区間です。この範囲内に真の係数があると95%の確率で信じられます。

### 残差分析

- **Omnibus**: オムニバス検定統計量（0.248）
- **Prob(Omnibus)**: オムニバス検定のp値（0.883）
  - 残差が正規分布に従うかどうかを調べる検定です。高いp値は正規分布の仮説を棄却しないことを示します。
- **Jarque-Bera (JB)**: ジャック・ベラ検定統計量（0.189）
- **Prob(JB)**: ジャック・ベラ検定のp値（0.910）
  - 残差が正規分布に従うかどうかを調べる別の検定です。高いp値は正規分布の仮説を棄却しないことを示します。
- **Skew**: 歪度（0.030）
  - 残差の分布の歪みを示します。0に近い値は対称性を示します。
- **Kurtosis**: 尖度（3.030）
  - 残差の分布の尖り具合を示します。3に近い値は正規分布に近いことを示します。
- **Durbin-Watson**: ダービン・ワトソン統計量（1.967）
  - 残差の自己相関を検出するための統計量です。2に近い値は自己相関がないことを示します。
- **Cond. No.**: 条件数（2.42）
  - モデルの数値的安定性を示します。高い値は多重共線性の問題を示す可能性があります。

### まとめ

この回帰分析の結果から、喫煙が肺がんに有意な影響を与えることが確認できますが、モデル全体の説明力は非常に低い（R-squaredが0.022）ため、喫煙以外にも肺がんに影響を与える要因が多く存在することが示唆されます。


```python
import matplotlib.pyplot as plt
import seaborn as sns
from matplotlib import font_manager

# フォントの設定
font_path = 'C:/Windows/Fonts/meiryo.ttc'
font_prop = font_manager.FontProperties(fname=font_path)
plt.rcParams['font.family'] = font_prop.get_name()

# 可視化のためのデータフレーム作成
data['predicted_lung_cancer_simple'] = model_simple.predict(sm.add_constant(data['smoking']))
data['predicted_lung_cancer_adjusted'] = model_adjusted.predict(sm.add_constant(data[['smoking', 'age']]))

# 可視化
plt.figure(figsize=(14, 6))

# 喫煙と肺がんの単純な関係
plt.subplot(1, 2, 1)
sns.scatterplot(x=data['smoking'], y=data['lung_cancer'], alpha=0.5)  # 喫煙と肺がんの散布図
sns.lineplot(x=data['smoking'], y=data['predicted_lung_cancer_simple'], color='red')  # 単純な回帰線
plt.title('喫煙と肺がんの単純な関係')
plt.xlabel('喫煙')
plt.ylabel('肺がん')

# 年齢を制御した喫煙と肺がんの関係
plt.subplot(1, 2, 2)
sns.scatterplot(x=data['smoking'], y=data['lung_cancer'], alpha=0.5)  # 喫煙と肺がんの散布図
sns.lineplot(x=data['smoking'], y=data['predicted_lung_cancer_adjusted'], color='red')  # 年齢を制御した回帰線
plt.title('年齢を制御した喫煙と肺がんの関係')
plt.xlabel('喫煙')
plt.ylabel('肺がん')

plt.tight_layout()  # レイアウトの調整
plt.show()

```


    
![png](output_3_0.png)
    


年齢を交絡因子として制御した場合でもモデルの説明力が低い理由は、肺がんに影響を与える他の重要な要因がモデルに含まれていない可能性があるためです。これらの要因を特定し、モデルに追加することで説明力を向上させることができます。以下にその具体的な改善策を示します。

### 改善策

1. **他の交絡因子の追加**:
   - 食事、運動習慣、遺伝的要因、環境要因（例: 大気汚染）、職業上のリスクなど、他の潜在的な交絡因子をモデルに追加します。

2. **相互作用項の追加**:
   - 変数間の相互作用を考慮することで、より複雑な関係をモデルに取り入れることができます。例えば、年齢と喫煙の相互作用項を追加します。

3. **非線形項の追加**:
   - 変数と肺がんの関係が非線形である場合、非線形項を追加することでモデルの適合性を向上させることができます。

4. **データの収集と品質向上**:
   - データセットのサイズを増やし、より多様なサンプルを含めることで、モデルの予測精度を向上させることができます。また、データの品質を向上させることも重要です。

### 改善策を反映したコード

以下に、他の交絡因子（ここでは食事と運動習慣を例に追加）および相互作用項を含むモデルの例を示します。

#### データ生成と回帰分析




```python
import numpy as np
import pandas as pd
import statsmodels.api as sm
import matplotlib.pyplot as plt
import seaborn as sns

# シードを設定して再現性を確保
np.random.seed(42)

# データの生成
N = 1000  # サンプル数
age = np.random.randint(18, 80, size=N)  # 18歳から80歳までのランダムな年齢データ
smoking = np.random.binomial(1, 0.3, size=N)  # 30%の人が喫煙者
diet = np.random.randint(1, 4, size=N)  # 食事の質（1から3のランク）
exercise = np.random.randint(0, 5, size=N)  # 週に何回運動するか
lung_cancer = 0.1 * age + 3 * smoking + 0.5 * diet - 1 * exercise + np.random.normal(0, 10, size=N)  # 肺がんの発生率

# データをデータフレームに変換
data = pd.DataFrame({'age': age, 'smoking': smoking, 'diet': diet, 'exercise': exercise, 'lung_cancer': lung_cancer})

# 年齢、食事、運動習慣、喫煙の相互作用項を含めた回帰分析
data['smoking_age_interaction'] = data['smoking'] * data['age']
model = sm.OLS(data['lung_cancer'], sm.add_constant(data[['age', 'smoking', 'diet', 'exercise', 'smoking_age_interaction']])).fit()
print("改善された回帰分析の結果：")
print(model.summary())

```

    改善された回帰分析の結果：
                                OLS Regression Results                            
    ==============================================================================
    Dep. Variable:            lung_cancer   R-squared:                       0.073
    Model:                            OLS   Adj. R-squared:                  0.069
    Method:                 Least Squares   F-statistic:                     15.71
    Date:                Sat, 22 Jun 2024   Prob (F-statistic):           6.63e-15
    Time:                        19:12:46   Log-Likelihood:                -3711.9
    No. Observations:                1000   AIC:                             7436.
    Df Residuals:                     994   BIC:                             7465.
    Df Model:                           5                                         
    Covariance Type:            nonrobust                                         
    ===========================================================================================
                                  coef    std err          t      P>|t|      [0.025      0.975]
    -------------------------------------------------------------------------------------------
    const                       0.3450      1.457      0.237      0.813      -2.515       3.205
    age                         0.0682      0.021      3.238      0.001       0.027       0.110
    smoking                     1.3802      1.975      0.699      0.485      -2.495       5.256
    diet                        1.3557      0.391      3.467      0.001       0.588       2.123
    exercise                   -1.1029      0.219     -5.042      0.000      -1.532      -0.674
    smoking_age_interaction     0.0390      0.037      1.048      0.295      -0.034       0.112
    ==============================================================================
    Omnibus:                        3.772   Durbin-Watson:                   1.973
    Prob(Omnibus):                  0.152   Jarque-Bera (JB):                3.311
    Skew:                          -0.065   Prob(JB):                        0.191
    Kurtosis:                       2.750   Cond. No.                         384.
    ==============================================================================
    
    Notes:
    [1] Standard Errors assume that the covariance matrix of the errors is correctly specified.
    




### 改善されたモデルの解釈

このモデルには、以下の要因が含まれています：
- **年齢**（`age`）
- **喫煙**（`smoking`）
- **食事の質**（`diet`）
- **運動習慣**（`exercise`）
- **喫煙と年齢の相互作用項**（`smoking_age_interaction`）

これにより、モデルはより多くの要因を考慮して肺がんのリスクを評価でき、説明力（R-squared）を向上させることが期待されます。必要に応じて、さらに多くの変数を追加することも検討できます。

### 可視化




```python

```



この改善されたモデルと可視化により、交絡因子を制御し、より多くの変数を考慮することで、肺がんリスクの評価がより正確になります。


```python

```


